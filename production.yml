version: "3.3"

services:
  nginx:
    image: nginx:1.13-alpine
    ports:
      - 443:443
    deploy:
      replicas: 2
    depends_on:
      - nginx_letsencrypt
    volumes:
      - dehydrated:/etc/dehydrated/
      - well_known:/var/www/dehydrated
      - deployment:/deployment
    environment:
      - MAIN_DOMAIN=test.netlimy.com
    configs:
      - source: nginx
        target: /nginx_production.conf
    command: sed -e 's/MAIN_DOMAIN/$$MAIN_DOMAIN/' /nginx_production.conf > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'

  netlimy:
    image: registry.gitlab.com/nukapi/netlimy:latest
    ports:
      - 80:80
    volumes:
      - dehydrated:/etc/dehydrated/
      - well_known:/var/www/dehydrated
      - website:/website
      - updater_state:/updater_state
      - deployment:/deployment
    environment:
      - WEBSITE_GIT_REPO=https://github.com/siavash9000/netlimy.com.git
      - PRODUCTION=true
      - DOMAINS=test.netlimy.com
    command: /run.sh

volumes:
  dehydrated:
  well_known:
  website:
  updater_state:
  deployment:

configs:
  nginx:
    file: conf/nginx/nginx_production.conf